<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CDSComponent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">DROP</a> &gt; <a href="index.source.html" class="el_package">org.drip.product.credit</a> &gt; <span class="el_source">CDSComponent.java</span></div><h1>CDSComponent.java</h1><pre class="source lang-java linenums">
package org.drip.product.credit;

/*
 * -*- mode: java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
 */

/*!
 * Copyright (C) 2019 Lakshmi Krishnamurthy
 * Copyright (C) 2018 Lakshmi Krishnamurthy
 * Copyright (C) 2017 Lakshmi Krishnamurthy
 * Copyright (C) 2016 Lakshmi Krishnamurthy
 * Copyright (C) 2015 Lakshmi Krishnamurthy
 * Copyright (C) 2014 Lakshmi Krishnamurthy
 * Copyright (C) 2013 Lakshmi Krishnamurthy
 * Copyright (C) 2012 Lakshmi Krishnamurthy
 * Copyright (C) 2011 Lakshmi Krishnamurthy
 * 
 *  This file is part of DROP, an open-source library targeting risk, transaction costs, exposure, margin
 *  	calculations, and portfolio construction within and across fixed income, credit, commodity, equity,
 *  	FX, and structured products.
 *  
 *  	https://lakshmidrip.github.io/DROP/
 *  
 *  DROP is composed of three main modules:
 *  
 *  - DROP Analytics Core - https://lakshmidrip.github.io/DROP-Analytics-Core/
 *  - DROP Portfolio Core - https://lakshmidrip.github.io/DROP-Portfolio-Core/
 *  - DROP Numerical Core - https://lakshmidrip.github.io/DROP-Numerical-Core/
 * 
 * 	DROP Analytics Core implements libraries for the following:
 * 	- Fixed Income Analytics
 * 	- Asset Backed Analytics
 * 	- XVA Analytics
 * 	- Exposure and Margin Analytics
 * 
 * 	DROP Portfolio Core implements libraries for the following:
 * 	- Asset Allocation Analytics
 * 	- Transaction Cost Analytics
 * 
 * 	DROP Numerical Core implements libraries for the following:
 * 	- Statistical Learning Library
 * 	- Numerical Optimizer Library
 * 	- Machine Learning Library
 * 	- Spline Builder Library
 * 
 * 	Documentation for DROP is Spread Over:
 * 
 * 	- Main                     =&gt; https://lakshmidrip.github.io/DROP/
 * 	- Wiki                     =&gt; https://github.com/lakshmiDRIP/DROP/wiki
 * 	- GitHub                   =&gt; https://github.com/lakshmiDRIP/DROP
 * 	- Javadoc                  =&gt; https://lakshmidrip.github.io/DROP/Javadoc/index.html
 * 	- Technical Specifications =&gt; https://github.com/lakshmiDRIP/DROP/tree/master/Docs/Internal
 * 	- Release Versions         =&gt; https://lakshmidrip.github.io/DROP/version.html
 * 	- Community Credits        =&gt; https://lakshmidrip.github.io/DROP/credits.html
 * 	- Issues Catalog           =&gt; https://github.com/lakshmiDRIP/DROP/issues
 * 	- JUnit                    =&gt; https://lakshmidrip.github.io/DROP/junit/index.html
 * 	- Jacoco                   =&gt; https://lakshmidrip.github.io/DROP/jacoco/index.html
 * 
 *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *   	you may not use this file except in compliance with the License.
 *   
 *  You may obtain a copy of the License at
 *  	http://www.apache.org/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  	distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *  	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  
 *  See the License for the specific language governing permissions and
 *  	limitations under the License.
 */

/**
 * &lt;i&gt;CDSComponent&lt;/i&gt; implements the credit default swap product contract details. It exposes the following
 *  functionality:
 * 
 * &lt;br&gt;&lt;br&gt;
 * &lt;ul&gt;
 *  &lt;li&gt;
 *  	Methods to extract effective date, maturity date, coupon, coupon day count, coupon frequency,
 *  	contingent credit, currency, basket notional, credit valuation parameters, and optionally the
 *  	outstanding notional schedule.
 *  &lt;/li&gt;
 *  &lt;li&gt;
 *  	Methods to compute the Jacobians to/from quote-to-latent state/manifest measures
 *  &lt;/li&gt;
 *  &lt;li&gt;
 *  	Serialization into and de-serialization out of byte arrays
 *  &lt;/li&gt;
 *  &lt;li&gt;
 *  	CDS specific methods such as such loss metric/Jacobian estimation, quote flat spread calibration etc:
 *  &lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * &lt;br&gt;&lt;br&gt;
 *  &lt;ul&gt;
 *		&lt;li&gt;&lt;b&gt;Project&lt;/b&gt;       = &lt;a href = &quot;https://github.com/lakshmiDRIP/DROP/tree/master/src/main/java/org/drip/product&quot;&gt;Product&lt;/a&gt;&lt;/li&gt;
 *		&lt;li&gt;&lt;b&gt;Package&lt;/b&gt;       = &lt;a href = &quot;https://github.com/lakshmiDRIP/DROP/tree/master/src/main/java/org/drip/product/credit&quot;&gt;Credit&lt;/a&gt;&lt;/li&gt;
 *		&lt;li&gt;&lt;b&gt;Specification&lt;/b&gt; = &lt;a href = &quot;https://github.com/lakshmiDRIP/DROP/tree/master/Docs/Internal/FixedIncome&quot;&gt;Fixed Income Analytics&lt;/a&gt;&lt;/li&gt;
 *  &lt;/ul&gt;
 * &lt;br&gt;&lt;br&gt;
 *
 * @author Lakshmi Krishnamurthy
 *
 */

public class CDSComponent extends org.drip.product.definition.CreditDefaultSwap {
<span class="fc" id="L109">	private double _dblNotional = 100.;</span>
<span class="fc" id="L110">	private java.lang.String _strCode = &quot;&quot;;</span>
<span class="fc" id="L111">	private java.lang.String _strName = &quot;&quot;;</span>
<span class="fc" id="L112">	private boolean _bApplyAccEOMAdj = false;</span>
<span class="fc" id="L113">	private boolean _bApplyCpnEOMAdj = false;</span>
<span class="fc" id="L114">	private java.lang.String _strCouponCurrency = &quot;&quot;;</span>
<span class="fc" id="L115">	private double _dblCoupon = java.lang.Double.NaN;</span>
<span class="fc" id="L116">	private int _iMaturityDate = java.lang.Integer.MIN_VALUE;</span>
<span class="fc" id="L117">	private int _iEffectiveDate = java.lang.Integer.MIN_VALUE;</span>
<span class="fc" id="L118">	private org.drip.quant.common.Array2D _notlSchedule = null;</span>
<span class="fc" id="L119">	private org.drip.product.params.CreditSetting _crValParams = null;</span>
<span class="fc" id="L120">	private org.drip.param.valuation.CashSettleParams _settleParams = null;</span>
<span class="fc" id="L121">	private java.util.List&lt;org.drip.analytics.cashflow.CompositePeriod&gt; _lsCouponPeriod = null;</span>

	private org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt; measures (
		final java.lang.String strMeasureSetPrefix,
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParamsIn,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp)
	{
<span class="pc bpc" id="L130" title="2 of 4 branches missed.">		if (null == valParams || null == csqs) return null;</span>

<span class="fc" id="L132">		org.drip.state.credit.CreditCurve cc = csqs.creditState (creditLabel());</span>

<span class="fc" id="L134">		org.drip.state.discount.MergedDiscountForwardCurve dcFunding = csqs.fundingState (fundingLabel());</span>

<span class="pc bpc" id="L136" title="2 of 4 branches missed.">		if (null == cc || null == dcFunding) return null;</span>

<span class="fc bfc" id="L138" title="All 2 branches covered.">		org.drip.param.pricer.CreditPricerParams pricerParams = null != pricerParamsIn ? pricerParamsIn :</span>
<span class="fc" id="L139">			org.drip.param.pricer.CreditPricerParams.Standard();</span>

<span class="fc" id="L141">		long lStart = System.nanoTime();</span>

<span class="fc" id="L143">		int iAccrualDays = 0;</span>
<span class="fc" id="L144">		double dblLossPV = 0.;</span>
<span class="fc" id="L145">		double dblExpLoss = 0.;</span>
<span class="fc" id="L146">		double dblAccrued01 = 0.;</span>
<span class="fc" id="L147">		double dblDirtyDV01 = 0.;</span>
<span class="fc" id="L148">		double dblLossNoRecPV = 0.;</span>
<span class="fc" id="L149">		double dblExpLossNoRec = 0.;</span>
<span class="fc" id="L150">		boolean bFirstPeriod = true;</span>
<span class="fc" id="L151">		double dblCashPayDF = java.lang.Double.NaN;</span>

<span class="fc" id="L153">		int iValueDate = valParams.valueDate();</span>

<span class="fc" id="L155">		int iLossPayLag = _crValParams.lossPayLag();</span>

		try {
<span class="fc bfc" id="L158" title="All 2 branches covered.">			for (org.drip.analytics.cashflow.CompositePeriod period : _lsCouponPeriod) {</span>
<span class="fc" id="L159">				int iPayDate = period.payDate();</span>

<span class="pc bpc" id="L161" title="1 of 2 branches missed.">				if (iPayDate &lt; iValueDate) continue;</span>

<span class="fc" id="L163">				int iEndDate = period.endDate();</span>

<span class="fc" id="L165">				int iStartDate = period.startDate();</span>

<span class="fc" id="L167">				double dblPeriodNotional = notional (iStartDate, iValueDate);</span>

<span class="fc bfc" id="L169" title="All 2 branches covered.">				if (bFirstPeriod) {</span>
<span class="fc" id="L170">					bFirstPeriod = false;</span>

<span class="fc bfc" id="L172" title="All 2 branches covered.">					if (iStartDate &lt; iValueDate) {</span>
<span class="fc" id="L173">						iAccrualDays = iValueDate - iStartDate;</span>

<span class="fc" id="L175">						dblAccrued01 = period.accrualDCF (iValueDate) * 0.01 * dblPeriodNotional;</span>
					}
				}

<span class="pc bpc" id="L179" title="1 of 2 branches missed.">				double dblSurvProb = pricerParams.survivalToPayDate() ? cc.survival (iPayDate) :</span>
<span class="fc" id="L180">					cc.survival (iEndDate);</span>

<span class="fc" id="L182">				dblDirtyDV01 += 0.01 * period.couponDCF() * dcFunding.df (iPayDate) * dblSurvProb *</span>
					dblPeriodNotional;

<span class="fc bfc" id="L185" title="All 2 branches covered.">				for (org.drip.analytics.cashflow.LossQuadratureMetrics lp : period.lossMetrics (this,</span>
					valParams, pricerParams, iEndDate, csqs)) {
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">					if (null == lp) continue;</span>

<span class="fc" id="L189">					int iSubPeriodEndDate = lp.endDate();</span>

<span class="fc" id="L191">					int iSubPeriodStartDate = lp.startDate();</span>

<span class="fc" id="L193">					double dblSubPeriodDF = dcFunding.effectiveDF (iSubPeriodStartDate + iLossPayLag,</span>
						iSubPeriodEndDate + iLossPayLag);

<span class="fc" id="L196">					double dblSubPeriodNotional = notional (iSubPeriodStartDate, iSubPeriodEndDate);</span>

<span class="fc" id="L198">					double dblSubPeriodSurvival = cc.survival (iSubPeriodStartDate) - cc.survival</span>
<span class="fc" id="L199">						(iSubPeriodEndDate);</span>

<span class="pc bpc" id="L201" title="1 of 2 branches missed.">					double dblRecovery = _crValParams.useCurveRecovery() ? cc.effectiveRecovery</span>
<span class="pc" id="L202">						(iSubPeriodStartDate, iSubPeriodEndDate) : _crValParams.recovery();</span>

<span class="fc" id="L204">					double dblSubPeriodExpLoss = (1. - dblRecovery) * 100. * dblSubPeriodSurvival *</span>
						dblSubPeriodNotional;
<span class="fc" id="L206">					double dblSubPeriodExpLossNoRec = 100. * dblSubPeriodSurvival * dblSubPeriodNotional;</span>
<span class="fc" id="L207">					dblLossPV += dblSubPeriodExpLoss * dblSubPeriodDF;</span>
<span class="fc" id="L208">					dblLossNoRecPV += dblSubPeriodExpLossNoRec * dblSubPeriodDF;</span>
<span class="fc" id="L209">					dblExpLoss += dblSubPeriodExpLoss;</span>
<span class="fc" id="L210">					dblExpLossNoRec += dblSubPeriodExpLossNoRec;</span>

<span class="fc" id="L212">					dblDirtyDV01 += 0.01 * lp.accrualDCF() * dblSubPeriodSurvival * dblSubPeriodDF *</span>
						dblSubPeriodNotional;
<span class="fc" id="L214">				}</span>
<span class="fc" id="L215">			}</span>

<span class="pc bpc" id="L217" title="1 of 2 branches missed.">			dblCashPayDF = dcFunding.df (null == _settleParams ? valParams.cashPayDate() :</span>
<span class="nc" id="L218">				_settleParams.cashSettleDate (iValueDate));</span>
<span class="nc" id="L219">		} catch (java.lang.Exception e) {</span>
<span class="nc" id="L220">			e.printStackTrace();</span>

<span class="nc" id="L222">			return null;</span>
<span class="fc" id="L223">		}</span>

<span class="fc" id="L225">		dblLossPV /= dblCashPayDF;</span>
<span class="fc" id="L226">		dblDirtyDV01 /= dblCashPayDF;</span>
<span class="fc" id="L227">		dblLossNoRecPV /= dblCashPayDF;</span>
<span class="fc" id="L228">		double dblNotlFactor = _dblNotional * 0.01;</span>
<span class="fc" id="L229">		double dblCleanDV01 = dblDirtyDV01 - dblAccrued01;</span>
<span class="fc" id="L230">		double dblCleanPV = dblCleanDV01 * 10000. * _dblCoupon - dblLossPV;</span>
<span class="fc" id="L231">		double dblDirtyPV = dblDirtyDV01 * 10000. * _dblCoupon - dblLossPV;</span>

<span class="fc" id="L233">		org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt; mapResult = new</span>
			org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt;();

<span class="fc" id="L236">		mapResult.put (strMeasureSetPrefix + &quot;AccrualDays&quot;, 1. * iAccrualDays);</span>

<span class="fc" id="L238">		mapResult.put (strMeasureSetPrefix + &quot;Accrued&quot;, dblAccrued01 * _dblCoupon * dblNotlFactor);</span>

<span class="fc" id="L240">		mapResult.put (strMeasureSetPrefix + &quot;Accrued01&quot;, dblAccrued01 * dblNotlFactor);</span>

<span class="fc" id="L242">		mapResult.put (strMeasureSetPrefix + &quot;CleanDV01&quot;, dblCleanDV01 * dblNotlFactor);</span>

<span class="fc" id="L244">		mapResult.put (strMeasureSetPrefix + &quot;CleanPV&quot;, dblCleanPV * dblNotlFactor);</span>

<span class="fc" id="L246">		mapResult.put (strMeasureSetPrefix + &quot;CleanCouponPV&quot;, dblCleanDV01 * _dblCoupon * dblNotlFactor);</span>

<span class="fc" id="L248">		mapResult.put (strMeasureSetPrefix + &quot;DirtyCouponPV&quot;, dblDirtyDV01 * _dblCoupon * dblNotlFactor);</span>

<span class="fc" id="L250">		mapResult.put (strMeasureSetPrefix + &quot;DirtyDV01&quot;, dblDirtyDV01 * dblNotlFactor);</span>

<span class="fc" id="L252">		mapResult.put (strMeasureSetPrefix + &quot;DirtyPV&quot;, dblDirtyPV * dblNotlFactor);</span>

<span class="fc" id="L254">		mapResult.put (strMeasureSetPrefix + &quot;DV01&quot;, dblDirtyDV01 * dblNotlFactor);</span>

<span class="fc" id="L256">		mapResult.put (strMeasureSetPrefix + &quot;ExpLoss&quot;, dblExpLoss * dblNotlFactor);</span>

<span class="fc" id="L258">		mapResult.put (strMeasureSetPrefix + &quot;ExpLossNoRec&quot;, dblExpLossNoRec * dblNotlFactor);</span>

<span class="fc" id="L260">		mapResult.put (strMeasureSetPrefix + &quot;FairPremium&quot;, dblLossPV / dblCleanDV01);</span>

<span class="fc" id="L262">		mapResult.put (strMeasureSetPrefix + &quot;LossNoRecPV&quot;, dblLossNoRecPV * dblNotlFactor);</span>

<span class="fc" id="L264">		mapResult.put (strMeasureSetPrefix + &quot;LossPV&quot;, dblLossPV * dblNotlFactor);</span>

<span class="fc" id="L266">		mapResult.put (strMeasureSetPrefix + &quot;ParSpread&quot;, dblLossPV / dblCleanDV01);</span>

<span class="fc" id="L268">		mapResult.put (strMeasureSetPrefix + &quot;PV&quot;, dblDirtyPV * dblNotlFactor);</span>

<span class="fc" id="L270">		mapResult.put (strMeasureSetPrefix + &quot;Upfront&quot;, dblCleanPV * dblNotlFactor);</span>

		try {
<span class="fc" id="L273">			double dblValueNotional = notional (iValueDate);</span>

<span class="fc" id="L275">			mapResult.put (strMeasureSetPrefix + &quot;CleanPrice&quot;, 100. * (1. + (dblCleanPV / _dblNotional /</span>
				dblValueNotional)));

<span class="fc" id="L278">			mapResult.put (strMeasureSetPrefix + &quot;DirtyPrice&quot;, 100. * (1. + (dblDirtyPV / _dblNotional /</span>
				dblValueNotional)));

<span class="fc" id="L281">			mapResult.put (strMeasureSetPrefix + &quot;LossOnInstantaneousDefault&quot;, _dblNotional * (1. -</span>
<span class="fc" id="L282">				cc.recovery (iValueDate)));</span>

<span class="fc" id="L284">			mapResult.put (strMeasureSetPrefix + &quot;Price&quot;, 100. * (1. + (dblCleanPV / _dblNotional /</span>
				dblValueNotional)));
<span class="nc" id="L286">		} catch (java.lang.Exception e) {</span>
<span class="nc" id="L287">			e.printStackTrace();</span>
<span class="fc" id="L288">		}</span>

<span class="fc" id="L290">		mapResult.put (strMeasureSetPrefix + &quot;CalcTime&quot;, (System.nanoTime() - lStart) * 1.e-09);</span>

<span class="fc" id="L292">		return mapResult;</span>
	}

	private org.drip.quant.calculus.WengertJacobian calcPeriodOnDefaultPVDFMicroJack (
		final double dblFairPremium,
		final org.drip.analytics.cashflow.CompositePeriod period,
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs)
	{
<span class="nc" id="L302">		org.drip.state.discount.MergedDiscountForwardCurve dcFunding = csqs.fundingState (fundingLabel());</span>

<span class="nc" id="L304">		int iNumParameters = 0;</span>
<span class="nc" id="L305">		org.drip.quant.calculus.WengertJacobian wjPeriodOnDefaultPVDF = null;</span>

<span class="nc bnc" id="L307" title="All 2 branches missed.">		for (org.drip.analytics.cashflow.LossQuadratureMetrics lpcf : period.lossMetrics (this, valParams,</span>
<span class="nc" id="L308">			pricerParams, period.endDate(), csqs)) {</span>
<span class="nc" id="L309">			org.drip.quant.calculus.WengertJacobian wjPeriodPayDFDF = dcFunding.jackDDFDManifestMeasure</span>
<span class="nc" id="L310">				((lpcf.startDate() + lpcf.endDate()) / 2 + _crValParams.lossPayLag(), &quot;Rate&quot;);</span>

			try {
<span class="nc bnc" id="L313" title="All 2 branches missed.">				if (null == wjPeriodOnDefaultPVDF)</span>
<span class="nc" id="L314">					wjPeriodOnDefaultPVDF = new org.drip.quant.calculus.WengertJacobian (1, iNumParameters =</span>
<span class="nc" id="L315">						wjPeriodPayDFDF.numParameters());</span>

<span class="nc" id="L317">				double dblPeriodIncrementalCashFlow = notional (lpcf.startDate(), lpcf.endDate()) *</span>
<span class="nc" id="L318">					(dblFairPremium * lpcf.accrualDCF() - 1. + lpcf.effectiveRecovery()) *</span>
<span class="nc" id="L319">						(lpcf.startSurvival() - lpcf.endSurvival());</span>

<span class="nc bnc" id="L321" title="All 2 branches missed.">				for (int k = 0; k &lt; iNumParameters; ++k) {</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">					if (!wjPeriodOnDefaultPVDF.accumulatePartialFirstDerivative (0, k,</span>
<span class="nc" id="L323">						wjPeriodPayDFDF.firstDerivative (0, k) * dblPeriodIncrementalCashFlow))</span>
<span class="nc" id="L324">						return null;</span>
				}
<span class="nc" id="L326">			} catch (java.lang.Exception e) {</span>
<span class="nc" id="L327">				e.printStackTrace();</span>

<span class="nc" id="L329">				return null;</span>
<span class="nc" id="L330">			}</span>
<span class="nc" id="L331">		}</span>

<span class="nc" id="L333">		return wjPeriodOnDefaultPVDF;</span>
	}

	private PeriodLossMicroJack calcPeriodLossMicroJack (
		final org.drip.analytics.cashflow.CompositePeriod period,
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs)
	{
<span class="nc" id="L342">		org.drip.state.discount.MergedDiscountForwardCurve dcFunding = csqs.fundingState (fundingLabel());</span>

<span class="nc" id="L344">		PeriodLossMicroJack plmj = null;</span>

<span class="nc bnc" id="L346" title="All 2 branches missed.">		for (org.drip.analytics.cashflow.LossQuadratureMetrics lpcf : period.lossMetrics (this, valParams,</span>
<span class="nc" id="L347">			pricerParams, period.endDate(), csqs)) {</span>
<span class="nc" id="L348">			double dblPeriodNotional = java.lang.Double.NaN;</span>
<span class="nc" id="L349">			double dblPeriodIncrementalLoss = java.lang.Double.NaN;</span>
<span class="nc" id="L350">			double dblPeriodIncrementalAccrual = java.lang.Double.NaN;</span>
<span class="nc" id="L351">			double dblPeriodIncrementalSurvival = java.lang.Double.NaN;</span>

<span class="nc" id="L353">			int iPeriodEffectiveDate = (lpcf.startDate() + lpcf.endDate()) / 2;</span>

<span class="nc" id="L355">			org.drip.quant.calculus.WengertJacobian wjPeriodPayDFDF = dcFunding.jackDDFDManifestMeasure</span>
<span class="nc" id="L356">				(iPeriodEffectiveDate + _crValParams.lossPayLag(), &quot;Rate&quot;);</span>

			try {
<span class="nc" id="L359">				dblPeriodNotional = notional (lpcf.startDate(), lpcf.endDate());</span>

<span class="nc" id="L361">				dblPeriodIncrementalSurvival = lpcf.startSurvival() - lpcf.endSurvival();</span>

<span class="nc" id="L363">				dblPeriodIncrementalLoss = dblPeriodNotional * (1. - lpcf.effectiveRecovery()) *</span>
					dblPeriodIncrementalSurvival;

<span class="nc" id="L366">				dblPeriodIncrementalAccrual = dblPeriodNotional * lpcf.accrualDCF() *</span>
					dblPeriodIncrementalSurvival;

<span class="nc bnc" id="L369" title="All 2 branches missed.">				if (null == plmj) plmj = new PeriodLossMicroJack (wjPeriodPayDFDF.numParameters());</span>

<span class="nc" id="L371">				plmj._dblAccrOnDef01 += dblPeriodIncrementalAccrual * dcFunding.df (iPeriodEffectiveDate +</span>
<span class="nc" id="L372">					_crValParams.lossPayLag());</span>
<span class="nc" id="L373">			} catch (java.lang.Exception e) {</span>
<span class="nc" id="L374">				e.printStackTrace();</span>

<span class="nc" id="L376">				return null;</span>
<span class="nc" id="L377">			}</span>

<span class="nc bnc" id="L379" title="All 2 branches missed.">			for (int k = 0; k &lt; wjPeriodPayDFDF.numParameters(); ++k) {</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">				if (!plmj._wjLossPVMicroJack.accumulatePartialFirstDerivative (0, k, dblPeriodIncrementalLoss</span>
<span class="nc" id="L381">					* wjPeriodPayDFDF.firstDerivative (0, k)))</span>
<span class="nc" id="L382">					return null;</span>

<span class="nc bnc" id="L384" title="All 2 branches missed.">				if (!plmj._wjAccrOnDef01MicroJack.accumulatePartialFirstDerivative (0, k,</span>
<span class="nc" id="L385">					dblPeriodIncrementalAccrual * wjPeriodPayDFDF.firstDerivative (0, k)))</span>
<span class="nc" id="L386">					return null;</span>
			}
<span class="nc" id="L388">		}</span>

<span class="nc" id="L390">		return plmj;</span>
	}

	private org.drip.analytics.cashflow.CompositePeriod calcCurrentPeriod (
		final int iDate)
	{
<span class="fc" id="L396">		org.drip.analytics.cashflow.CompositePeriod cpFirst = _lsCouponPeriod.get (0);</span>

<span class="pc bpc" id="L398" title="1 of 2 branches missed.">		if (iDate &lt;= cpFirst.startDate()) return cpFirst;</span>

<span class="pc bpc" id="L400" title="1 of 2 branches missed.">		for (org.drip.analytics.cashflow.CompositePeriod period : _lsCouponPeriod) {</span>
			try {
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">				if (period.contains (iDate)) return period;</span>
<span class="nc" id="L403">			} catch (java.lang.Exception e) {</span>
<span class="nc" id="L404">				e.printStackTrace();</span>

<span class="nc" id="L406">				return null;</span>
<span class="nc" id="L407">			}</span>
<span class="nc" id="L408">		}</span>

<span class="nc" id="L410">		return null;</span>
	}

	/**
	 * CDSComponent constructor: Most generic CDS creation functionality
	 * 
	 * @param iEffectiveDate Effective Date
	 * @param iMaturityDate Maturity Date
	 * @param dblCoupon Coupon
	 * @param iFreq Frequency
	 * @param strCouponDC Coupon DC
	 * @param strAccrualDC Accrual DC
	 * @param strFloatingRateIndex Floating Rate Index
	 * @param bConvCDS Is CDS Conventional
	 * @param dapEffective Effective DAP
	 * @param dapMaturity Maturity DAP
	 * @param dapPeriodStart Period Start DAP
	 * @param dapPeriodEnd Period End DAP
	 * @param dapAccrualStart Accrual Start DAP
	 * @param dapAccrualEnd Accrual End DAP
	 * @param dapPay Pay DAP
	 * @param dapReset Reset DAP
	 * @param notlSchedule Notional Schedule
	 * @param dblNotional Notional Amount
	 * @param strCouponCurrency Coupon Currency
	 * @param crValParams Credit Valuation Parameters
	 * @param strCalendar Calendar
	 * 
	 * @throws java.lang.Exception Thrown if Inputs are Invalid
	 */

	public CDSComponent (
		final int iEffectiveDate,
		final int iMaturityDate,
		final double dblCoupon,
		final int iFreq,
		final java.lang.String strCouponDC,
		final java.lang.String strAccrualDC,
		final java.lang.String strFloatingRateIndex,
		final boolean bConvCDS,
		final org.drip.analytics.daycount.DateAdjustParams dapEffective,
		final org.drip.analytics.daycount.DateAdjustParams dapMaturity,
		final org.drip.analytics.daycount.DateAdjustParams dapPeriodStart,
		final org.drip.analytics.daycount.DateAdjustParams dapPeriodEnd,
		final org.drip.analytics.daycount.DateAdjustParams dapAccrualStart,
		final org.drip.analytics.daycount.DateAdjustParams dapAccrualEnd,
		final org.drip.analytics.daycount.DateAdjustParams dapPay,
		final org.drip.analytics.daycount.DateAdjustParams dapReset,
		final org.drip.quant.common.Array2D notlSchedule,
		final double dblNotional,
		final java.lang.String strCouponCurrency,
		final org.drip.product.params.CreditSetting crValParams,
		final java.lang.String strCalendar)
		throws java.lang.Exception
<span class="fc" id="L464">	{</span>
<span class="pc bpc" id="L465" title="3 of 6 branches missed.">		if (null == strCouponCurrency || (_strCouponCurrency = strCouponCurrency).isEmpty() || null ==</span>
<span class="pc bpc" id="L466" title="1 of 2 branches missed.">			crValParams || !org.drip.quant.common.NumberUtil.IsValid (dblCoupon))</span>
<span class="nc" id="L467">			throw new java.lang.Exception (&quot;CDSComponent ctr: Invalid params!&quot;);</span>

<span class="fc" id="L469">		_dblCoupon = dblCoupon;</span>
<span class="fc" id="L470">		_crValParams = crValParams;</span>
<span class="fc" id="L471">		java.lang.String strTenor = (12 / iFreq) + &quot;M&quot;;</span>

<span class="pc bpc" id="L473" title="1 of 2 branches missed.">		if (null == (_notlSchedule = notlSchedule))</span>
<span class="fc" id="L474">			_notlSchedule = org.drip.quant.common.Array2D.BulletSchedule();</span>

<span class="fc" id="L476">		org.drip.param.period.UnitCouponAccrualSetting ucas = new</span>
			org.drip.param.period.UnitCouponAccrualSetting (iFreq, strCouponDC, _bApplyCpnEOMAdj,
				strAccrualDC, _bApplyAccEOMAdj, _strCouponCurrency, true,
					org.drip.analytics.support.CompositePeriodBuilder.ACCRUAL_COMPOUNDING_RULE_GEOMETRIC);

<span class="fc" id="L481">		org.drip.param.period.ComposableFixedUnitSetting cfus = new</span>
			org.drip.param.period.ComposableFixedUnitSetting (strTenor,
				org.drip.analytics.support.CompositePeriodBuilder.EDGE_DATE_SEQUENCE_SINGLE, null, 0., 0.,
					_strCouponCurrency);

<span class="pc bpc" id="L486" title="1 of 2 branches missed.">		org.drip.param.period.CompositePeriodSetting cps = new org.drip.param.period.CompositePeriodSetting</span>
			(iFreq, strTenor, _strCouponCurrency, null, _dblNotional = dblNotional, null, _notlSchedule,
				null, null == _crValParams ? null : org.drip.state.identifier.EntityCDSLabel.Standard
<span class="fc" id="L489">					(_crValParams.creditCurveName(), _strCouponCurrency));</span>

<span class="fc" id="L491">		java.util.List&lt;java.lang.Integer&gt; lsStreamEdgeDate =</span>
<span class="fc" id="L492">			org.drip.analytics.support.CompositePeriodBuilder.BackwardEdgeDates (new</span>
				org.drip.analytics.date.JulianDate (_iEffectiveDate = iEffectiveDate), new
					org.drip.analytics.date.JulianDate (_iMaturityDate = iMaturityDate), strTenor,
						dapAccrualEnd, org.drip.analytics.support.CompositePeriodBuilder.SHORT_STUB);

<span class="fc" id="L497">		if (null == (_lsCouponPeriod = org.drip.analytics.support.CompositePeriodBuilder.FixedCompositeUnit</span>
<span class="pc bpc" id="L498" title="2 of 4 branches missed.">			(lsStreamEdgeDate, cps, ucas, cfus)) || 0 == _lsCouponPeriod.size())</span>
<span class="nc" id="L499">			throw new java.lang.Exception (&quot;CDSComponent ctr: Cannot make Coupon Period List!&quot;);</span>
<span class="fc" id="L500">	}</span>

	@Override public java.lang.String primaryCode()
	{
<span class="fc" id="L504">		return _strCode;</span>
	}

	@Override public void setPrimaryCode (
		final java.lang.String strCode)
	{
<span class="fc" id="L510">		_strCode = strCode;</span>
<span class="fc" id="L511">	}</span>

	public boolean setName (
		final java.lang.String strName)
	{
<span class="nc" id="L516">		_strName = strName;</span>
<span class="nc" id="L517">		return true;</span>
	}

	@Override public java.lang.String name()
	{
<span class="pc bpc" id="L522" title="2 of 4 branches missed.">		if (null != _strName &amp;&amp; !_strName.isEmpty()) return _strName;</span>

<span class="fc" id="L524">		return &quot;CDS=&quot; + org.drip.analytics.date.DateUtil.YYYYMMDD (_iMaturityDate);</span>
	}

	@Override public org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.String&gt; couponCurrency()
	{
<span class="nc" id="L529">		org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.String&gt; mapCouponCurrency = new</span>
			org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.String&gt;();

<span class="nc" id="L532">		mapCouponCurrency.put (name(), _strCouponCurrency);</span>

<span class="nc" id="L534">		return mapCouponCurrency;</span>
	}

	@Override public java.lang.String payCurrency()
	{
<span class="fc" id="L539">		return _strCouponCurrency;</span>
	}

	@Override public java.lang.String principalCurrency()
	{
<span class="nc" id="L544">		return null;</span>
	}

	@Override public double initialNotional()
	{
<span class="fc" id="L549">		return _dblNotional;</span>
	}

	@Override public double notional (
		final int iDate)
		throws java.lang.Exception
	{
<span class="pc bpc" id="L556" title="1 of 2 branches missed.">		if (null == _notlSchedule) throw new java.lang.Exception (&quot;CDSComponent::notional =&gt; Bad date&quot;);</span>

<span class="fc" id="L558">		return _notlSchedule.y (iDate);</span>
	}

	@Override public double notional (
		final int iDate1,
		final int iDate2)
		throws java.lang.Exception
	{
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">		if (null == _notlSchedule) throw new java.lang.Exception (&quot;CDSComponent::notional =&gt; Bad date&quot;);</span>

<span class="fc" id="L568">		return _notlSchedule.y (iDate1, iDate2);</span>
	}

	@Override public double recovery (
		final int iDate,
		final org.drip.state.credit.CreditCurve cc)
		throws java.lang.Exception
	{
<span class="nc bnc" id="L576" title="All 2 branches missed.">		if (null == cc) throw new java.lang.Exception (&quot;CDSComponent::recovery =&gt; Bad inputs&quot;);</span>

<span class="nc bnc" id="L578" title="All 2 branches missed.">		return _crValParams.useCurveRecovery() ? cc.recovery (iDate) : _crValParams.recovery();</span>
	}

	@Override public double recovery (
		final int iDateStart,
		final int iDateEnd,
		final org.drip.state.credit.CreditCurve cc)
		throws java.lang.Exception
	{
<span class="pc bpc" id="L587" title="1 of 2 branches missed.">		if (null == cc) throw new java.lang.Exception (&quot;CDSComponent::recovery: Bad inputs&quot;);</span>

<span class="pc bpc" id="L589" title="1 of 2 branches missed.">		double dblRecovery = _crValParams.useCurveRecovery() ? cc.effectiveRecovery (iDateStart, iDateEnd) :</span>
<span class="pc" id="L590">			_crValParams.recovery();</span>

<span class="fc" id="L592">		return dblRecovery;</span>
	}

	@Override public org.drip.product.params.CreditSetting creditValuationParams()
	{
<span class="fc" id="L597">		return _crValParams;</span>
	}

	@Override public org.drip.analytics.output.CompositePeriodCouponMetrics couponMetrics (
		final int iAccrualEndDate,
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs)
	{
		try {
<span class="fc" id="L606">			org.drip.analytics.cashflow.CompositePeriod period = calcCurrentPeriod (iAccrualEndDate);</span>

<span class="pc bpc" id="L608" title="1 of 2 branches missed.">			return null == period ? null : period.couponMetrics (iAccrualEndDate, csqs);</span>
<span class="nc" id="L609">		} catch (java.lang.Exception e) {</span>
<span class="nc" id="L610">			e.printStackTrace();</span>
		}

<span class="nc" id="L613">		return null;</span>
	}

	@Override public int freq()
	{
<span class="fc" id="L618">		return couponPeriods().get (0).freq();</span>
	}

	@Override public org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt; calibMeasures (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp)
	{
<span class="nc" id="L627">		return null;</span>
	}

	@Override public org.drip.state.identifier.EntityCDSLabel creditLabel()
	{
<span class="pc bpc" id="L632" title="2 of 4 branches missed.">		return null == _crValParams || null == _crValParams.creditCurveName() ||</span>
<span class="pc bpc" id="L633" title="1 of 2 branches missed.">			_crValParams.creditCurveName().isEmpty() ? null : org.drip.state.identifier.EntityCDSLabel.Standard</span>
<span class="fc" id="L634">				(_crValParams.creditCurveName(), _strCouponCurrency);</span>
	}

	@Override public
		org.drip.analytics.support.CaseInsensitiveTreeMap&lt;org.drip.state.identifier.ForwardLabel&gt;
			forwardLabel()
	{
<span class="nc" id="L641">		return null;</span>
	}

	@Override public
		org.drip.analytics.support.CaseInsensitiveTreeMap&lt;org.drip.state.identifier.OTCFixFloatLabel&gt;
			otcFixFloatLabel()
	{
<span class="nc" id="L648">		return null;</span>
	}

	@Override public org.drip.state.identifier.FundingLabel fundingLabel()
	{
<span class="fc" id="L653">		return org.drip.state.identifier.FundingLabel.Standard (_strCouponCurrency);</span>
	}

	@Override public org.drip.state.identifier.GovvieLabel govvieLabel()
	{
<span class="nc" id="L658">		return org.drip.state.identifier.GovvieLabel.Standard (payCurrency());</span>
	}

	@Override public org.drip.analytics.support.CaseInsensitiveTreeMap&lt;org.drip.state.identifier.FXLabel&gt;
		fxLabel()
	{
<span class="nc" id="L664">		return null;</span>
	}

	@Override public
		org.drip.analytics.support.CaseInsensitiveTreeMap&lt;org.drip.state.identifier.VolatilityLabel&gt;
			volatilityLabel()
	{
<span class="nc" id="L671">		return null;</span>
	}

	@Override public org.drip.analytics.date.JulianDate effectiveDate()
	{
		try {
<span class="fc" id="L677">			return new org.drip.analytics.date.JulianDate (_iEffectiveDate);</span>
<span class="nc" id="L678">		} catch (java.lang.Exception e) {</span>
<span class="nc" id="L679">			e.printStackTrace();</span>
		}

<span class="nc" id="L682">		return null;</span>
	}

	@Override public org.drip.analytics.date.JulianDate maturityDate()
	{
		try {
<span class="fc" id="L688">			return new org.drip.analytics.date.JulianDate (_iMaturityDate);</span>
<span class="nc" id="L689">		} catch (java.lang.Exception e) {</span>
<span class="nc" id="L690">			e.printStackTrace();</span>
		}

<span class="nc" id="L693">		return null;</span>
	}

	@Override public org.drip.analytics.date.JulianDate firstCouponDate()
	{
		try {
<span class="nc" id="L699">			return new org.drip.analytics.date.JulianDate (_lsCouponPeriod.get (0).endDate());</span>
<span class="nc" id="L700">		} catch (java.lang.Exception e) {</span>
<span class="nc" id="L701">			e.printStackTrace();</span>
		}

<span class="nc" id="L704">		return null;</span>
	}

	@Override public java.util.List&lt;org.drip.analytics.cashflow.CompositePeriod&gt; couponPeriods()
	{
<span class="fc" id="L709">		return _lsCouponPeriod;</span>
	}

	@Override public org.drip.param.valuation.CashSettleParams cashSettleParams()
	{
<span class="nc" id="L714">		return _settleParams;</span>
	}

	@Override public java.util.List&lt;org.drip.analytics.cashflow.LossQuadratureMetrics&gt; lossFlow (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs)
	{
<span class="pc bpc" id="L722" title="2 of 4 branches missed.">		if (null == valParams || null == pricerParams) return null;</span>

<span class="fc" id="L724">		java.util.List&lt;org.drip.analytics.cashflow.LossQuadratureMetrics&gt; sLP = new</span>
			java.util.ArrayList&lt;org.drip.analytics.cashflow.LossQuadratureMetrics&gt;();

<span class="fc" id="L727">		int iValueDate = valParams.valueDate();</span>

<span class="fc bfc" id="L729" title="All 2 branches covered.">		for (org.drip.analytics.cashflow.CompositePeriod period : _lsCouponPeriod) {</span>
<span class="fc" id="L730">			int iPeriodEndDate = period.endDate();</span>

<span class="pc bpc" id="L732" title="2 of 4 branches missed.">			if (null == period || iPeriodEndDate &lt; iValueDate) continue;</span>

<span class="fc" id="L734">			java.util.List&lt;org.drip.analytics.cashflow.LossQuadratureMetrics&gt; sLPSub = period.lossMetrics</span>
<span class="fc" id="L735">				(this, valParams, pricerParams, iPeriodEndDate, csqs);</span>

<span class="pc bpc" id="L737" title="1 of 2 branches missed.">			if (null != sLPSub) sLP.addAll (sLPSub);</span>
<span class="fc" id="L738">		}</span>

<span class="fc" id="L740">		return sLP;</span>
	}

	@Override public org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt; value (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp)
	{
<span class="fc" id="L749">		org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt; mapFairMeasures = measures (&quot;&quot;,</span>
			valParams, pricerParams, csqs, vcp);

<span class="pc bpc" id="L752" title="1 of 2 branches missed.">		if (null == mapFairMeasures) return null;</span>

<span class="fc" id="L754">		org.drip.quant.common.CollectionUtil.MergeWithMain (mapFairMeasures,</span>
<span class="fc" id="L755">			org.drip.quant.common.CollectionUtil.PrefixKeys (mapFairMeasures, &quot;Fair&quot;));</span>

<span class="fc" id="L757">		org.drip.analytics.cashflow.ComposableUnitPeriod cupFirst = _lsCouponPeriod.get (0).periods().get</span>
<span class="fc" id="L758">			(0);</span>

		try {
<span class="fc" id="L761">			mapFairMeasures.put (&quot;CumulativeCouponAmount&quot;, _dblNotional * _dblCoupon *</span>
<span class="fc" id="L762">				org.drip.analytics.daycount.Convention.YearFraction (_iEffectiveDate, valParams.valueDate(),</span>
<span class="fc" id="L763">					cupFirst.couponDC(), _bApplyAccEOMAdj, null, cupFirst.calendar()));</span>
<span class="nc" id="L764">		} catch (java.lang.Exception e) {</span>
<span class="nc" id="L765">			e.printStackTrace();</span>
<span class="fc" id="L766">		}</span>

<span class="fc" id="L768">		java.lang.String strName = name();</span>

<span class="fc" id="L770">		org.drip.param.definition.ProductQuote cq = csqs.productQuote (strName);</span>

<span class="pc bpc" id="L772" title="2 of 8 branches missed.">		if ((null != pricerParams &amp;&amp; null != pricerParams.calibParams()) || null == mapFairMeasures || null</span>
			== cq)
<span class="fc" id="L774">			return mapFairMeasures;</span>

<span class="nc" id="L776">		double dblCreditBasis = java.lang.Double.NaN;</span>
<span class="nc" id="L777">		double dblMarketMeasure = java.lang.Double.NaN;</span>
<span class="nc" id="L778">		org.drip.state.credit.CreditCurve ccMarket = null;</span>

<span class="nc bnc" id="L780" title="All 2 branches missed.">		if (cq.containsQuote (&quot;Price&quot;))</span>
<span class="nc" id="L781">			mapFairMeasures.put (&quot;MarketInputType=Price&quot;, dblMarketMeasure = cq.quote (&quot;Price&quot;).value</span>
<span class="nc" id="L782">				(&quot;mid&quot;));</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">		else if (cq.containsQuote (&quot;CleanPrice&quot;))</span>
<span class="nc" id="L784">			mapFairMeasures.put (&quot;MarketInputType=CleanPrice&quot;, dblMarketMeasure = cq.quote</span>
<span class="nc" id="L785">				(&quot;CleanPrice&quot;).value (&quot;mid&quot;));</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">		else if (cq.containsQuote (&quot;Upfront&quot;))</span>
<span class="nc" id="L787">			mapFairMeasures.put (&quot;MarketInputType=Upfront&quot;, dblMarketMeasure = cq.quote (&quot;Upfront&quot;).value</span>
<span class="nc" id="L788">				(&quot;mid&quot;));</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">		else if (cq.containsQuote (&quot;FairPremium&quot;))</span>
<span class="nc" id="L790">			mapFairMeasures.put (&quot;MarketInputType=FairPremium&quot;, dblMarketMeasure = cq.quote</span>
<span class="nc" id="L791">				(&quot;FairPremium&quot;).value (&quot;mid&quot;));</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">		else if (cq.containsQuote (&quot;PV&quot;))</span>
<span class="nc" id="L793">			mapFairMeasures.put (&quot;MarketInputType=PV&quot;, dblMarketMeasure = cq.quote (&quot;PV&quot;).value (&quot;mid&quot;));</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">		else if (cq.containsQuote (&quot;CleanPV&quot;))</span>
<span class="nc" id="L795">			mapFairMeasures.put (&quot;MarketInputType=CleanPV&quot;, dblMarketMeasure = cq.quote (&quot;CleanPV&quot;).value</span>
<span class="nc" id="L796">				(&quot;mid&quot;));</span>

		try {
<span class="nc" id="L799">			SpreadCalibOP scop = new SpreadCalibrator (this,</span>
<span class="nc" id="L800">				SpreadCalibrator.CALIBRATION_TYPE_NODE_PARALLEL_BUMP).calibrateHazardFromPrice (valParams,</span>
					new org.drip.param.pricer.CreditPricerParams (7,
<span class="nc" id="L802">						org.drip.param.definition.CalibrationParams.Standard(), false,</span>
							org.drip.param.pricer.CreditPricerParams.PERIOD_DISCRETIZATION_DAY_STEP), csqs,
								vcp, dblMarketMeasure);

<span class="nc bnc" id="L806" title="All 2 branches missed.">			if (null != scop) {</span>
<span class="nc" id="L807">				ccMarket = scop._ccCalib;</span>
<span class="nc" id="L808">				dblCreditBasis = scop._dblCalibResult;</span>
			}
<span class="nc" id="L810">		} catch (java.lang.Exception e) {</span>
<span class="nc" id="L811">			e.printStackTrace();</span>
<span class="nc" id="L812">		}</span>

<span class="nc bnc" id="L814" title="All 2 branches missed.">		if (org.drip.quant.common.NumberUtil.IsValid (dblCreditBasis)) {</span>
<span class="nc" id="L815">			mapFairMeasures.put (&quot;MarketCreditBasis&quot;, dblCreditBasis);</span>

<span class="nc" id="L817">			org.drip.state.credit.CreditCurve cc = csqs.creditState (creditLabel());</span>

			try {
<span class="nc" id="L820">				ccMarket = (org.drip.state.credit.CreditCurve) cc.customTweakManifestMeasure</span>
<span class="nc" id="L821">					(&quot;FairPremium&quot;, new org.drip.param.definition.ManifestMeasureTweak</span>
						(org.drip.param.definition.ManifestMeasureTweak.FLAT, false, dblCreditBasis));
<span class="nc" id="L823">			} catch (java.lang.Exception e) {</span>
<span class="nc" id="L824">				e.printStackTrace();</span>
<span class="nc" id="L825">			}</span>
		}

<span class="nc" id="L828">		org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt; mapMeasures = mapFairMeasures;</span>

<span class="nc bnc" id="L830" title="All 2 branches missed.">		if (null != ccMarket) {</span>
<span class="nc" id="L831">			org.drip.param.market.CurveSurfaceQuoteContainer csqsMarket =</span>
<span class="nc" id="L832">				org.drip.param.creator.MarketParamsBuilder.Create (csqs.fundingState (fundingLabel()),</span>
<span class="nc" id="L833">					csqs.govvieState (org.drip.state.identifier.GovvieLabel.Standard (payCurrency())),</span>
<span class="nc" id="L834">						ccMarket, strName, csqs.productQuote (strName), csqs.quoteMap(), csqs.fixings());</span>

<span class="nc bnc" id="L836" title="All 2 branches missed.">			if (null != csqsMarket) {</span>
<span class="nc" id="L837">				org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt; mapMarketMeasures =</span>
<span class="nc" id="L838">					measures (&quot;&quot;, valParams, pricerParams, csqsMarket, vcp);</span>

<span class="nc bnc" id="L840" title="All 2 branches missed.">				if (null != mapMarketMeasures) {</span>
<span class="nc" id="L841">					org.drip.quant.common.CollectionUtil.MergeWithMain (mapMarketMeasures,</span>
<span class="nc" id="L842">						org.drip.quant.common.CollectionUtil.PrefixKeys (mapMarketMeasures, &quot;Market&quot;));</span>

<span class="nc" id="L844">					org.drip.quant.common.CollectionUtil.MergeWithMain (mapMeasures, mapMarketMeasures);</span>
				}
			}
		}

<span class="nc" id="L849">		return mapMeasures;</span>
	}

	@Override public java.util.Set&lt;java.lang.String&gt; measureNames()
	{
<span class="nc" id="L854">		java.util.Set&lt;java.lang.String&gt; setstrMeasureNames = new java.util.TreeSet&lt;java.lang.String&gt;();</span>

<span class="nc" id="L856">		setstrMeasureNames.add (&quot;AccrualDays&quot;);</span>

<span class="nc" id="L858">		setstrMeasureNames.add (&quot;Accrued&quot;);</span>

<span class="nc" id="L860">		setstrMeasureNames.add (&quot;Accrued01&quot;);</span>

<span class="nc" id="L862">		setstrMeasureNames.add (&quot;CleanCouponPV&quot;);</span>

<span class="nc" id="L864">		setstrMeasureNames.add (&quot;CleanDV01&quot;);</span>

<span class="nc" id="L866">		setstrMeasureNames.add (&quot;CleanPV&quot;);</span>

<span class="nc" id="L868">		setstrMeasureNames.add (&quot;DirtyCouponPV&quot;);</span>

<span class="nc" id="L870">		setstrMeasureNames.add (&quot;DirtyDV01&quot;);</span>

<span class="nc" id="L872">		setstrMeasureNames.add (&quot;DirtyPV&quot;);</span>

<span class="nc" id="L874">		setstrMeasureNames.add (&quot;DV01&quot;);</span>

<span class="nc" id="L876">		setstrMeasureNames.add (&quot;ExpLoss&quot;);</span>

<span class="nc" id="L878">		setstrMeasureNames.add (&quot;ExpLossNoRec&quot;);</span>

<span class="nc" id="L880">		setstrMeasureNames.add (&quot;FairAccrualDays&quot;);</span>

<span class="nc" id="L882">		setstrMeasureNames.add (&quot;FairAccrued&quot;);</span>

<span class="nc" id="L884">		setstrMeasureNames.add (&quot;FairAccrued01&quot;);</span>

<span class="nc" id="L886">		setstrMeasureNames.add (&quot;FairCleanDV01&quot;);</span>

<span class="nc" id="L888">		setstrMeasureNames.add (&quot;FairCleanPV&quot;);</span>

<span class="nc" id="L890">		setstrMeasureNames.add (&quot;FairDirtyDV01&quot;);</span>

<span class="nc" id="L892">		setstrMeasureNames.add (&quot;FairDirtyPV&quot;);</span>

<span class="nc" id="L894">		setstrMeasureNames.add (&quot;FairDV01&quot;);</span>

<span class="nc" id="L896">		setstrMeasureNames.add (&quot;FairExpLoss&quot;);</span>

<span class="nc" id="L898">		setstrMeasureNames.add (&quot;FairExpLossNoRec&quot;);</span>

<span class="nc" id="L900">		setstrMeasureNames.add (&quot;FairFairPremium&quot;);</span>

<span class="nc" id="L902">		setstrMeasureNames.add (&quot;FairLossNoRecPV&quot;);</span>

<span class="nc" id="L904">		setstrMeasureNames.add (&quot;FairLossPV&quot;);</span>

<span class="nc" id="L906">		setstrMeasureNames.add (&quot;FairParSpread&quot;);</span>

<span class="nc" id="L908">		setstrMeasureNames.add (&quot;FairPremium&quot;);</span>

<span class="nc" id="L910">		setstrMeasureNames.add (&quot;FairPremiumPV&quot;);</span>

<span class="nc" id="L912">		setstrMeasureNames.add (&quot;FairPV&quot;);</span>

<span class="nc" id="L914">		setstrMeasureNames.add (&quot;FairUpfront&quot;);</span>

<span class="nc" id="L916">		setstrMeasureNames.add (&quot;LossNoRecPV&quot;);</span>

<span class="nc" id="L918">		setstrMeasureNames.add (&quot;LossPV&quot;);</span>

<span class="nc" id="L920">		setstrMeasureNames.add (&quot;MarketAccrualDays&quot;);</span>

<span class="nc" id="L922">		setstrMeasureNames.add (&quot;MarketAccrued&quot;);</span>

<span class="nc" id="L924">		setstrMeasureNames.add (&quot;MarketAccrued01&quot;);</span>

<span class="nc" id="L926">		setstrMeasureNames.add (&quot;MarketCleanDV01&quot;);</span>

<span class="nc" id="L928">		setstrMeasureNames.add (&quot;MarketCleanPV&quot;);</span>

<span class="nc" id="L930">		setstrMeasureNames.add (&quot;MarketDirtyDV01&quot;);</span>

<span class="nc" id="L932">		setstrMeasureNames.add (&quot;MarketDirtyPV&quot;);</span>

<span class="nc" id="L934">		setstrMeasureNames.add (&quot;MarketDV01&quot;);</span>

<span class="nc" id="L936">		setstrMeasureNames.add (&quot;MarketExpLoss&quot;);</span>

<span class="nc" id="L938">		setstrMeasureNames.add (&quot;MarketExpLossNoRec&quot;);</span>

<span class="nc" id="L940">		setstrMeasureNames.add (&quot;MarketFairPremium&quot;);</span>

<span class="nc" id="L942">		setstrMeasureNames.add (&quot;MarketLossNoRecPV&quot;);</span>

<span class="nc" id="L944">		setstrMeasureNames.add (&quot;MarketLossPV&quot;);</span>

<span class="nc" id="L946">		setstrMeasureNames.add (&quot;MarketParSpread&quot;);</span>

<span class="nc" id="L948">		setstrMeasureNames.add (&quot;MarketPremiumPV&quot;);</span>

<span class="nc" id="L950">		setstrMeasureNames.add (&quot;MarketPV&quot;);</span>

<span class="nc" id="L952">		setstrMeasureNames.add (&quot;MarketUpfront&quot;);</span>

<span class="nc" id="L954">		setstrMeasureNames.add (&quot;ParSpread&quot;);</span>

<span class="nc" id="L956">		setstrMeasureNames.add (&quot;PV&quot;);</span>

<span class="nc" id="L958">		setstrMeasureNames.add (&quot;Upfront&quot;);</span>

<span class="nc" id="L960">		return setstrMeasureNames;</span>
	}

	@Override public double pv (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParamsIn,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqc,
		final org.drip.param.valuation.ValuationCustomizationParams vcp)
		throws java.lang.Exception
	{
<span class="nc bnc" id="L970" title="All 4 branches missed.">		if (null == valParams || null == csqc)</span>
<span class="nc" id="L971">			throw new java.lang.Exception (&quot;CDSComponent::pv =&gt; Invalid Inputs&quot;);</span>

<span class="nc" id="L973">		org.drip.state.credit.CreditCurve cc = csqc.creditState (creditLabel());</span>

<span class="nc" id="L975">		org.drip.state.discount.MergedDiscountForwardCurve dcFunding = csqc.fundingState (fundingLabel());</span>

<span class="nc bnc" id="L977" title="All 4 branches missed.">		if (null == cc || null == dcFunding)</span>
<span class="nc" id="L978">			throw new java.lang.Exception (&quot;CDSComponent::pv =&gt; Invalid Inputs&quot;);</span>

<span class="nc bnc" id="L980" title="All 2 branches missed.">		org.drip.param.pricer.CreditPricerParams pricerParams = null != pricerParamsIn ? pricerParamsIn :</span>
<span class="nc" id="L981">			org.drip.param.pricer.CreditPricerParams.Standard();</span>

<span class="nc" id="L983">		double dblLossPV = 0.;</span>
<span class="nc" id="L984">		double dblDirtyDV01 = 0.;</span>

<span class="nc" id="L986">		int iValueDate = valParams.valueDate();</span>

<span class="nc bnc" id="L988" title="All 2 branches missed.">		for (org.drip.analytics.cashflow.CompositePeriod period : _lsCouponPeriod) {</span>
<span class="nc" id="L989">			int iPayDate = period.payDate();</span>

<span class="nc bnc" id="L991" title="All 2 branches missed.">			if (iPayDate &lt; iValueDate) continue;</span>

<span class="nc" id="L993">			int iEndDate = period.endDate();</span>

<span class="nc" id="L995">			int iStartDate = period.startDate();</span>

<span class="nc" id="L997">			int iLossPayLag = _crValParams.lossPayLag();</span>

<span class="nc" id="L999">			double dblPeriodNotional = notional (iStartDate, iValueDate);</span>

<span class="nc" id="L1001">			dblDirtyDV01 += 0.01 * period.couponDCF() * dcFunding.df (iPayDate) *</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">				(pricerParams.survivalToPayDate() ? cc.survival (iPayDate) : cc.survival (iEndDate)) *</span>
					dblPeriodNotional;

<span class="nc bnc" id="L1005" title="All 2 branches missed.">			for (org.drip.analytics.cashflow.LossQuadratureMetrics lp : period.lossMetrics (this, valParams,</span>
				pricerParams, iEndDate, csqc)) {
<span class="nc bnc" id="L1007" title="All 2 branches missed.">				if (null == lp) continue;</span>

<span class="nc" id="L1009">				int iSubPeriodEndDate = lp.endDate();</span>

<span class="nc" id="L1011">				int iSubPeriodStartDate = lp.startDate();</span>

<span class="nc" id="L1013">				double dblSubPeriodDF = dcFunding.effectiveDF (iSubPeriodStartDate + iLossPayLag,</span>
					iSubPeriodEndDate + iLossPayLag);

<span class="nc" id="L1016">				double dblSubPeriodNotional = notional (iSubPeriodStartDate, iSubPeriodEndDate);</span>

<span class="nc" id="L1018">				double dblSubPeriodSurvival = cc.survival (iSubPeriodStartDate) - cc.survival</span>
<span class="nc" id="L1019">					(iSubPeriodEndDate);</span>

<span class="nc bnc" id="L1021" title="All 2 branches missed.">				double dblSubPeriodExpLoss = (1. - (_crValParams.useCurveRecovery() ? cc.effectiveRecovery</span>
<span class="nc" id="L1022">					(iSubPeriodStartDate, iSubPeriodEndDate) : _crValParams.recovery())) * 100. *</span>
						dblSubPeriodSurvival * dblSubPeriodNotional;

<span class="nc" id="L1025">				dblLossPV += dblSubPeriodExpLoss * dblSubPeriodDF;</span>

<span class="nc" id="L1027">				dblDirtyDV01 += 0.01 * lp.accrualDCF() * dblSubPeriodSurvival * dblSubPeriodDF *</span>
					dblSubPeriodNotional;
<span class="nc" id="L1029">			}</span>
<span class="nc" id="L1030">		}</span>

<span class="nc bnc" id="L1032" title="All 2 branches missed.">		return (dblDirtyDV01 * 10000. * _dblCoupon - dblLossPV) * _dblNotional * 0.01 / dcFunding.df (null ==</span>
<span class="nc" id="L1033">			_settleParams ? valParams.cashPayDate() : _settleParams.cashSettleDate (iValueDate));</span>
	}

	@Override public org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt;
		valueFromQuotedSpread (
			final org.drip.param.valuation.ValuationParams valParams,
			final org.drip.param.pricer.CreditPricerParams pricerParams,
			final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
			final org.drip.param.valuation.ValuationCustomizationParams vcp,
			final double dblFixCoupon,
			final double dblQuotedSpread)
	{
<span class="pc bpc" id="L1045" title="2 of 4 branches missed.">		if (null == valParams || !org.drip.quant.common.NumberUtil.IsValid (dblFixCoupon) ||</span>
<span class="pc bpc" id="L1046" title="1 of 2 branches missed.">			!org.drip.quant.common.NumberUtil.IsValid (dblQuotedSpread))</span>
<span class="nc" id="L1047">			return null;</span>

<span class="fc" id="L1049">		org.drip.product.definition.CalibratableComponent[] aComp = new</span>
			org.drip.product.definition.CalibratableComponent[] {this};
<span class="fc" id="L1051">		org.drip.state.credit.CreditCurve cc = null;</span>
<span class="fc" id="L1052">		double[] adblRestorableCDSCoupon = new double[1];</span>
<span class="fc" id="L1053">		adblRestorableCDSCoupon[0] = _dblCoupon;</span>
<span class="fc" id="L1054">		_dblCoupon = dblFixCoupon;</span>

<span class="pc bpc" id="L1056" title="1 of 2 branches missed.">		if (null != csqs) {</span>
<span class="fc" id="L1057">			org.drip.product.definition.CalibratableComponent[] aMktComp = null;</span>

<span class="fc" id="L1059">			cc = csqs.creditState (creditLabel());</span>

<span class="pc bpc" id="L1061" title="2 of 4 branches missed.">			if (null != cc &amp;&amp; null != (aMktComp = cc.calibComp())) {</span>
<span class="fc" id="L1062">				int iNumComp = aMktComp.length;</span>

<span class="pc bpc" id="L1064" title="1 of 2 branches missed.">				if (0 != iNumComp) {</span>
<span class="fc" id="L1065">					aComp = aMktComp;</span>
<span class="fc" id="L1066">					adblRestorableCDSCoupon = new double[iNumComp];</span>

<span class="fc bfc" id="L1068" title="All 2 branches covered.">					for (int i = 0; i &lt; iNumComp; ++i) {</span>
<span class="pc bpc" id="L1069" title="2 of 4 branches missed.">						if (null != aComp[i] &amp;&amp; aComp[i] instanceof</span>
							org.drip.product.definition.CreditDefaultSwap) {
							try {
<span class="fc" id="L1072">								org.drip.analytics.output.CompositePeriodCouponMetrics cpcm = couponMetrics</span>
<span class="fc" id="L1073">									(valParams.valueDate(), valParams, csqs);</span>

<span class="pc bpc" id="L1075" title="1 of 2 branches missed.">								if (null == cpcm) return null;</span>

<span class="fc" id="L1077">								adblRestorableCDSCoupon[i] = cpcm.rate();</span>

<span class="fc" id="L1079">								((org.drip.product.definition.CreditDefaultSwap) aComp[i]).resetCoupon</span>
<span class="fc" id="L1080">									(dblFixCoupon);</span>
<span class="nc" id="L1081">							} catch (java.lang.Exception e) {</span>
<span class="nc" id="L1082">								e.printStackTrace();</span>

<span class="nc" id="L1084">								return null;</span>
<span class="fc" id="L1085">							}</span>
						}
					}
				}
			}
		}

<span class="fc" id="L1092">		int iNumCalibComp = aComp.length;</span>
<span class="fc" id="L1093">		double[] adblQS = new double[iNumCalibComp];</span>
<span class="fc" id="L1094">		org.drip.state.credit.CreditCurve ccQS = null;</span>
<span class="fc" id="L1095">		java.lang.String[] astrCalibMeasure = new java.lang.String[iNumCalibComp];</span>

<span class="fc bfc" id="L1097" title="All 2 branches covered.">		for (int i = 0; i &lt; iNumCalibComp; ++i) {</span>
<span class="fc" id="L1098">			adblQS[i] = dblQuotedSpread;</span>
<span class="fc" id="L1099">			astrCalibMeasure[i] = &quot;FairPremium&quot;;</span>
		}

<span class="fc" id="L1102">		org.drip.state.discount.MergedDiscountForwardCurve dcFunding = csqs.fundingState (fundingLabel());</span>

		try {
<span class="fc" id="L1105">			if (null == (ccQS = org.drip.state.creator.ScenarioCreditCurveBuilder.Custom</span>
<span class="pc bpc" id="L1106" title="1 of 2 branches missed.">				(creditLabel().referenceEntity(), new org.drip.analytics.date.JulianDate</span>
<span class="pc bpc" id="L1107" title="1 of 2 branches missed.">					(valParams.valueDate()), aComp, dcFunding, adblQS, astrCalibMeasure, null != cc ?</span>
<span class="pc" id="L1108">						cc.recovery (valParams.valueDate()) : 0.4, true)))</span>
<span class="nc" id="L1109">				return null;</span>
<span class="nc" id="L1110">		} catch (java.lang.Exception e) {</span>
<span class="nc" id="L1111">			e.printStackTrace();</span>

<span class="nc" id="L1113">			return null;</span>
<span class="fc" id="L1114">		}</span>

<span class="fc" id="L1116">		org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt; mapPV = value (valParams,</span>
<span class="fc" id="L1117">			pricerParams, org.drip.param.creator.MarketParamsBuilder.Credit (dcFunding, ccQS), vcp);</span>

<span class="fc bfc" id="L1119" title="All 2 branches covered.">		for (int i = 0; i &lt; iNumCalibComp; ++i) {</span>
			try {
<span class="fc" id="L1121">				((org.drip.product.definition.CreditDefaultSwap) aComp[i]).resetCoupon</span>
<span class="fc" id="L1122">					(adblRestorableCDSCoupon[i]);</span>
<span class="nc" id="L1123">			} catch (java.lang.Exception e) {</span>
<span class="nc" id="L1124">				e.printStackTrace();</span>

<span class="nc" id="L1126">				return null;</span>
<span class="fc" id="L1127">			}</span>
		}

<span class="fc" id="L1130">		return mapPV;</span>
	}

	@Override public org.drip.quant.calculus.WengertJacobian jackDDirtyPVDManifestMeasure (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp)
	{
<span class="nc bnc" id="L1139" title="All 4 branches missed.">		if (null == valParams || null == csqs) return null;</span>

<span class="nc" id="L1141">		int iValueDate = valParams.valueDate();</span>

<span class="nc bnc" id="L1143" title="All 2 branches missed.">		if (iValueDate &gt;= _iMaturityDate) return null;</span>

<span class="nc" id="L1145">		org.drip.state.credit.CreditCurve cc = csqs.creditState (creditLabel());</span>

<span class="nc" id="L1147">		org.drip.state.discount.MergedDiscountForwardCurve dc = csqs.fundingState (fundingLabel());</span>

<span class="nc bnc" id="L1149" title="All 4 branches missed.">		if (null == cc || null == dc) return null;</span>

<span class="nc" id="L1151">		org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt; mapMeasures = value (valParams,</span>
			pricerParams, csqs, vcp);

<span class="nc bnc" id="L1154" title="All 2 branches missed.">		if (null == mapMeasures) return null;</span>

<span class="nc" id="L1156">		double dblPV = mapMeasures.get (&quot;PV&quot;);</span>

<span class="nc" id="L1158">		double dblFairPremium = mapMeasures.get (&quot;FairPremium&quot;);</span>

		try {
<span class="nc" id="L1161">			org.drip.quant.calculus.WengertJacobian wjPVDFMicroJack = null;</span>

<span class="nc bnc" id="L1163" title="All 2 branches missed.">			for (org.drip.analytics.cashflow.CompositePeriod p : _lsCouponPeriod) {</span>
<span class="nc" id="L1164">				int iPeriodPayDate = p.payDate();</span>

<span class="nc bnc" id="L1166" title="All 2 branches missed.">				if (iPeriodPayDate &lt; iValueDate) continue;</span>

<span class="nc" id="L1168">				org.drip.quant.calculus.WengertJacobian wjPeriodPayDFDF = dc.jackDDFDManifestMeasure</span>
<span class="nc" id="L1169">					(iPeriodPayDate, &quot;Rate&quot;);</span>

<span class="nc" id="L1171">				org.drip.quant.calculus.WengertJacobian wjPeriodOnDefaultPVMicroJack =</span>
<span class="nc" id="L1172">					calcPeriodOnDefaultPVDFMicroJack (dblFairPremium, p, valParams, pricerParams, csqs);</span>

<span class="nc bnc" id="L1174" title="All 6 branches missed.">				if (null == wjPeriodPayDFDF | null == wjPeriodOnDefaultPVMicroJack) continue;</span>

<span class="nc bnc" id="L1176" title="All 2 branches missed.">				if (null == wjPVDFMicroJack)</span>
<span class="nc" id="L1177">					wjPVDFMicroJack = new org.drip.quant.calculus.WengertJacobian (1,</span>
<span class="nc" id="L1178">						wjPeriodPayDFDF.numParameters());</span>

<span class="nc" id="L1180">				double dblPeriodCashFlow = dblFairPremium * notional (p.startDate(), p.endDate()) *</span>
<span class="nc" id="L1181">					p.couponDCF() * cc.survival (iPeriodPayDate);</span>

<span class="nc bnc" id="L1183" title="All 2 branches missed.">				for (int k = 0; k &lt; wjPeriodPayDFDF.numParameters(); ++k) {</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">					if (!wjPVDFMicroJack.accumulatePartialFirstDerivative (0, k, dblPeriodCashFlow *</span>
<span class="nc" id="L1185">						wjPeriodPayDFDF.firstDerivative (0, k) + wjPeriodOnDefaultPVMicroJack.firstDerivative</span>
<span class="nc" id="L1186">							(0, k)))</span>
<span class="nc" id="L1187">						return null;</span>
				}
<span class="nc" id="L1189">			}</span>

<span class="nc bnc" id="L1191" title="All 2 branches missed.">			return adjustForCashSettle (valParams.cashPayDate(), dblPV, dc, wjPVDFMicroJack) ?</span>
				wjPVDFMicroJack : null;
<span class="nc" id="L1193">		} catch (java.lang.Exception e) {</span>
<span class="nc" id="L1194">			e.printStackTrace();</span>
		}

<span class="nc" id="L1197">		return null;</span>
	}

	@Override public org.drip.quant.calculus.WengertJacobian manifestMeasureDFMicroJack (
		final java.lang.String strManifestMeasure,
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp)
	{
<span class="nc bnc" id="L1207" title="All 6 branches missed.">		if (null == valParams || null == strManifestMeasure || null == csqs) return null;</span>

<span class="nc" id="L1209">		int iValueDate = valParams.valueDate();</span>

<span class="nc bnc" id="L1211" title="All 2 branches missed.">		if (iValueDate &gt;= _iMaturityDate) return null;</span>

<span class="nc" id="L1213">		org.drip.state.credit.CreditCurve cc = csqs.creditState (creditLabel());</span>

<span class="nc" id="L1215">		org.drip.state.discount.MergedDiscountForwardCurve dcFunding = csqs.fundingState (fundingLabel());</span>

<span class="nc bnc" id="L1217" title="All 4 branches missed.">		if (null == cc || null == dcFunding) return null;</span>

<span class="nc bnc" id="L1219" title="All 2 branches missed.">		if (&quot;Rate&quot;.equalsIgnoreCase (strManifestMeasure) || &quot;FairPremium&quot;.equalsIgnoreCase</span>
<span class="nc bnc" id="L1220" title="All 4 branches missed.">			(strManifestMeasure) || &quot;ParSpread&quot;.equalsIgnoreCase (strManifestMeasure)) {</span>
<span class="nc" id="L1221">			org.drip.analytics.support.CaseInsensitiveTreeMap&lt;java.lang.Double&gt; mapMeasures = value</span>
<span class="nc" id="L1222">				(valParams, pricerParams, csqs, vcp);</span>

<span class="nc bnc" id="L1224" title="All 2 branches missed.">			if (null == mapMeasures) return null;</span>

<span class="nc" id="L1226">			double dblFairPremium = mapMeasures.get (&quot;FairPremium&quot;);</span>

			try {
<span class="nc" id="L1229">				double dblDV01 = 0.;</span>
<span class="nc" id="L1230">				org.drip.quant.calculus.WengertJacobian wjFairPremiumDFMicroJack = null;</span>

<span class="nc bnc" id="L1232" title="All 2 branches missed.">				for (org.drip.analytics.cashflow.CompositePeriod p : _lsCouponPeriod) {</span>
<span class="nc" id="L1233">					int iPeriodPayDate = p.payDate();</span>

<span class="nc bnc" id="L1235" title="All 2 branches missed.">					if (iPeriodPayDate &lt; iValueDate) continue;</span>

<span class="nc" id="L1237">					int iPeriodEndDate = p.endDate();</span>

<span class="nc" id="L1239">					org.drip.quant.calculus.WengertJacobian wjPeriodPayDFDF =</span>
<span class="nc" id="L1240">						dcFunding.jackDDFDManifestMeasure (iPeriodEndDate, &quot;Rate&quot;);</span>

<span class="nc" id="L1242">					PeriodLossMicroJack plmj = calcPeriodLossMicroJack (p, valParams, pricerParams, csqs);</span>

<span class="nc bnc" id="L1244" title="All 6 branches missed.">					if (null == wjPeriodPayDFDF | null == plmj) continue;</span>

<span class="nc bnc" id="L1246" title="All 2 branches missed.">					if (null == wjFairPremiumDFMicroJack)</span>
<span class="nc" id="L1247">						wjFairPremiumDFMicroJack = new org.drip.quant.calculus.WengertJacobian (1,</span>
<span class="nc" id="L1248">							wjPeriodPayDFDF.numParameters());</span>

<span class="nc" id="L1250">					double dblPeriodCoupon01 = notional (p.startDate(), iPeriodEndDate) * p.couponDCF() *</span>
<span class="nc" id="L1251">						cc.survival (iPeriodEndDate);</span>

<span class="nc" id="L1253">					dblDV01 += dblPeriodCoupon01 * dcFunding.df (iPeriodPayDate) + plmj._dblAccrOnDef01;</span>

<span class="nc bnc" id="L1255" title="All 2 branches missed.">					for (int k = 0; k &lt; wjPeriodPayDFDF.numParameters(); ++k) {</span>
<span class="nc" id="L1256">						double dblPeriodNetLossJack = plmj._wjLossPVMicroJack.firstDerivative (0, k) -</span>
<span class="nc" id="L1257">							dblFairPremium * (plmj._wjAccrOnDef01MicroJack.firstDerivative (0, k) +</span>
<span class="nc" id="L1258">								dblPeriodCoupon01 * wjPeriodPayDFDF.firstDerivative (0, k));</span>

<span class="nc bnc" id="L1260" title="All 2 branches missed.">						if (!wjFairPremiumDFMicroJack.accumulatePartialFirstDerivative (0, k,</span>
							dblPeriodNetLossJack))
<span class="nc" id="L1262">							return null;</span>
					}
<span class="nc" id="L1264">				}</span>

<span class="nc bnc" id="L1266" title="All 2 branches missed.">				return wjFairPremiumDFMicroJack.scale (dblDV01) ? wjFairPremiumDFMicroJack : null;</span>
<span class="nc" id="L1267">			} catch (java.lang.Exception e) {</span>
<span class="nc" id="L1268">				e.printStackTrace();</span>
			}
		}

<span class="nc" id="L1272">		return null;</span>
	}

	@Override public org.drip.product.calib.ProductQuoteSet calibQuoteSet (
		final org.drip.state.representation.LatentStateSpecification[] aLSS)
	{
<span class="nc" id="L1278">		return null;</span>
	}

	@Override public org.drip.state.estimator.PredictorResponseWeightConstraint fundingPRWC (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp,
		final org.drip.product.calib.ProductQuoteSet pqs)
	{
<span class="nc" id="L1288">		return null;</span>
	}

	@Override public org.drip.state.estimator.PredictorResponseWeightConstraint forwardPRWC (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp,
		final org.drip.product.calib.ProductQuoteSet pqs)
	{
<span class="nc" id="L1298">		return null;</span>
	}

	@Override public org.drip.state.estimator.PredictorResponseWeightConstraint fundingForwardPRWC (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp,
		final org.drip.product.calib.ProductQuoteSet pqs)
	{
<span class="nc" id="L1308">		return null;</span>
	}

	@Override public org.drip.state.estimator.PredictorResponseWeightConstraint fxPRWC (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp,
		final org.drip.product.calib.ProductQuoteSet pqs)
	{
<span class="nc" id="L1318">		return null;</span>
	}

	@Override public org.drip.state.estimator.PredictorResponseWeightConstraint govviePRWC (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp,
		final org.drip.product.calib.ProductQuoteSet pqs)
	{
<span class="nc" id="L1328">		return null;</span>
	}

	@Override public org.drip.state.estimator.PredictorResponseWeightConstraint volatilityPRWC (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp,
		final org.drip.product.calib.ProductQuoteSet pqs)
	{
<span class="nc" id="L1338">		return null;</span>
	}

	/**
	 * Reset the CDS's coupon
	 * 
	 * @param dblCoupon The new Coupon
	 * 
	 * @return The old Coupon
	 * 
	 * @throws java.lang.Exception Thrown if the coupon cannot be reset
	 */

	public double resetCoupon (
		final double dblCoupon)
		throws java.lang.Exception
	{
<span class="fc" id="L1355">		double dblOldCoupon = _dblCoupon;</span>

<span class="pc bpc" id="L1357" title="1 of 2 branches missed.">		if (!org.drip.quant.common.NumberUtil.IsValid (_dblCoupon = dblCoupon))</span>
<span class="nc" id="L1358">			throw new java.lang.Exception (&quot;CDSComponent::resetCoupon =&gt; Bad coupon Input!&quot;);</span>

<span class="fc" id="L1360">		return dblOldCoupon;</span>
	}

	/**
	 * Calibrate the CDS's flat spread from the calculated up-front points
	 * 
	 * @param valParams ValuationParams
	 * @param pricerParams PricerParams
	 * @param csqs ComponentMarketParams
	 * 
	 * @return Calibrated flat spread
	 * 
	 * @throws java.lang.Exception Thrown if cannot calibrate
	 */

	public double calibFlatSpread (
		final org.drip.param.valuation.ValuationParams valParams,
		final org.drip.param.pricer.CreditPricerParams pricerParams,
		final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
		final org.drip.param.valuation.ValuationCustomizationParams vcp)
		throws java.lang.Exception
	{
<span class="nc" id="L1382">		SpreadCalibOP scop = new SpreadCalibrator (this,</span>
<span class="nc" id="L1383">			SpreadCalibrator.CALIBRATION_TYPE_FLAT_CURVE_NODES).calibrateHazardFromPrice (valParams,</span>
<span class="nc" id="L1384">				pricerParams, csqs, vcp, measureValue (valParams, pricerParams, csqs, vcp, &quot;Upfront&quot;));</span>

<span class="nc bnc" id="L1386" title="All 2 branches missed.">		if (null == scop)</span>
<span class="nc" id="L1387">			throw new java.lang.Exception (&quot;CDSComponent::calibFlatSpread =&gt; Cannot calibrate flat spread!&quot;);</span>

<span class="nc" id="L1389">		return scop._dblCalibResult;</span>
	}

	/**
	 *	CDS spread calibration output
	 *
	 * @author Lakshmi Krishnamurthy
	 */

	public class SpreadCalibOP {
<span class="nc" id="L1399">		public double _dblCalibResult = java.lang.Double.NaN;</span>
<span class="nc" id="L1400">		public org.drip.state.credit.CreditCurve _ccCalib = null;</span>

		public SpreadCalibOP (
			final double dblCalibResult,
			final org.drip.state.credit.CreditCurve ccCalib)
			throws java.lang.Exception
<span class="nc" id="L1406">		{</span>
<span class="nc bnc" id="L1407" title="All 4 branches missed.">			if (!org.drip.quant.common.NumberUtil.IsValid (_dblCalibResult = dblCalibResult) || null ==</span>
				(_ccCalib = ccCalib))
<span class="nc" id="L1409">				throw new java.lang.Exception (&quot;CDSComponent::SpreadCalibOP ctr =&gt; Invalid inputs!&quot;);</span>
<span class="nc" id="L1410">		}</span>
	}

	/**
	 *	Implementation of the CDS spread calibrator
	 *
	 * @author Lakshmi Krishnamurthy
	 */

	public class SpreadCalibrator {
<span class="nc" id="L1420">		private org.drip.product.definition.CreditDefaultSwap _cds = null;</span>

		/*
		 * Calibration Type
		 */

		public static final int CALIBRATION_TYPE_FLAT_INSTRUMENT_NODE = 1;
		public static final int CALIBRATION_TYPE_FLAT_CURVE_NODES = 2;
		public static final int CALIBRATION_TYPE_NODE_PARALLEL_BUMP = 4;

<span class="nc" id="L1430">		private int _iCalibType = CALIBRATION_TYPE_FLAT_CURVE_NODES;</span>

		/**
		 * Constructor: Construct the SpreadCalibrator from the CDS parent, and whether the calibration is
		 * 	off of a single node
		 * 
		 * @param cds CDS parent
		 * @param iCalibType Calibration type indicating whether the calibration is PARALLEL, FLAT SINGLE
		 * 		NODE, or FLAT TERM
		 * 
		 * @throws java.lang.Exception Thrown if inputs are invalid
		 */

		public SpreadCalibrator (
			final org.drip.product.definition.CreditDefaultSwap cds,
			final int iCalibType)
			throws java.lang.Exception
<span class="nc" id="L1447">		{</span>
<span class="nc bnc" id="L1448" title="All 8 branches missed.">			if (null == (_cds = cds) || (CALIBRATION_TYPE_FLAT_INSTRUMENT_NODE != (_iCalibType = iCalibType)</span>
				&amp;&amp; CALIBRATION_TYPE_FLAT_CURVE_NODES != iCalibType &amp;&amp; CALIBRATION_TYPE_NODE_PARALLEL_BUMP !=
					iCalibType))
<span class="nc" id="L1451">				throw new java.lang.Exception (&quot;CDSComponent::SpreadCalibrator ctr =&gt; Invalid inputs!&quot;);</span>
<span class="nc" id="L1452">		}</span>

		/**
		 * Calibrate the hazard rate from calibration price
		 * 
		 * @param valParams ValuationParams
		 * @param pricerParams PricerParams
		 * @param csqs ComponentMarketParams
		 * @param vcp Valuation Customization Parameters
		 * @param dblPriceCalib Market price to be calibrated
		 * 
		 * @return Calibrated hazard
		 */

		public SpreadCalibOP calibrateHazardFromPrice (
			final org.drip.param.valuation.ValuationParams valParams,
			final org.drip.param.pricer.CreditPricerParams pricerParams,
			final org.drip.param.market.CurveSurfaceQuoteContainer csqs,
			final org.drip.param.valuation.ValuationCustomizationParams vcp,
			final double dblPriceCalib)
		{
<span class="nc bnc" id="L1473" title="All 6 branches missed.">			if (null == valParams || null == pricerParams || null == csqs ||</span>
<span class="nc bnc" id="L1474" title="All 2 branches missed.">				!org.drip.quant.common.NumberUtil.IsValid (dblPriceCalib))</span>
<span class="nc" id="L1475">				return null;</span>

<span class="nc" id="L1477">			final org.drip.state.credit.CreditCurve ccOld = csqs.creditState (creditLabel());</span>

<span class="nc" id="L1479">			org.drip.function.definition.R1ToR1 ofCDSPriceFromFlatSpread = new</span>
<span class="nc" id="L1480">				org.drip.function.definition.R1ToR1 (null) {</span>
				@Override public double evaluate (
					final double dblFlatSpread)
					throws java.lang.Exception
				{
<span class="nc bnc" id="L1485" title="All 2 branches missed.">					if (CALIBRATION_TYPE_NODE_PARALLEL_BUMP != _iCalibType)</span>
<span class="nc" id="L1486">						csqs.setCreditState (ccOld.flatCurve (dblFlatSpread,</span>
<span class="nc bnc" id="L1487" title="All 2 branches missed.">							CALIBRATION_TYPE_FLAT_CURVE_NODES == _iCalibType, java.lang.Double.NaN));</span>
					else
<span class="nc" id="L1489">						csqs.setCreditState ((org.drip.state.credit.CreditCurve)</span>
<span class="nc" id="L1490">							ccOld.customTweakManifestMeasure (&quot;FairPremium&quot;, new</span>
								org.drip.param.definition.ManifestMeasureTweak
									(org.drip.param.definition.ManifestMeasureTweak.FLAT, false,
										dblFlatSpread)));

<span class="nc" id="L1495">					return _cds.measureValue (valParams, pricerParams, csqs, vcp, &quot;Upfront&quot;) - dblPriceCalib;</span>
				}
			};

			try {
<span class="nc" id="L1500">				org.drip.function.r1tor1solver.FixedPointFinderOutput rfop = new</span>
					org.drip.function.r1tor1solver.FixedPointFinderBrent (0., ofCDSPriceFromFlatSpread,
<span class="nc" id="L1502">						true).findRoot();</span>

<span class="nc bnc" id="L1504" title="All 6 branches missed.">				if (null == rfop || !rfop.containsRoot() &amp;&amp; !csqs.setCreditState (ccOld))</span>
<span class="nc" id="L1505">					return new SpreadCalibOP (rfop.getRoot(), ccOld);</span>
<span class="nc" id="L1506">			} catch (java.lang.Exception e) {</span>
<span class="nc" id="L1507">				e.printStackTrace();</span>
<span class="nc" id="L1508">			}</span>

<span class="nc" id="L1510">			return null;</span>
		}
	}

	class PeriodLossMicroJack {
<span class="nc" id="L1515">		double _dblAccrOnDef01 = 0.;</span>
<span class="nc" id="L1516">		org.drip.quant.calculus.WengertJacobian _wjLossPVMicroJack = null;</span>
<span class="nc" id="L1517">		org.drip.quant.calculus.WengertJacobian _wjAccrOnDef01MicroJack = null;</span>

		PeriodLossMicroJack (
			final int iNumParameters)
			throws java.lang.Exception
<span class="nc" id="L1522">		{</span>
<span class="nc" id="L1523">			_wjLossPVMicroJack = new org.drip.quant.calculus.WengertJacobian (1, iNumParameters);</span>

<span class="nc" id="L1525">			_wjAccrOnDef01MicroJack = new org.drip.quant.calculus.WengertJacobian (1, iNumParameters);</span>
<span class="nc" id="L1526">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>